name: æ‰‹åŠ¨åŒæ­¥åˆ†æ”¯

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'æºåˆ†æ”¯ (é€šå¸¸æ˜¯ main)'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - develop
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯ (é€šå¸¸æ˜¯ private)'
        required: true
        default: 'private'
        type: choice
        options:
          - private
          - staging
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ (å°†è¦†ç›–ç›®æ ‡åˆ†æ”¯çš„å†²çªæ–‡ä»¶)'
        required: false
        default: false
        type: boolean
      sync_message:
        description: 'åŒæ­¥è¯´æ˜Ž (å¯é€‰)'
        required: false
        default: ''
        type: string

jobs:
  manual-sync:
    name: æ‰‹åŠ¨åˆ†æ”¯åŒæ­¥
    runs-on: ubuntu-latest
    
    steps:
      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          echo "ðŸ” åŒæ­¥å‚æ•°éªŒè¯"
          echo "æºåˆ†æ”¯: ${{ github.event.inputs.source_branch }}"
          echo "ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
          echo "å¼ºåˆ¶åŒæ­¥: ${{ github.event.inputs.force_sync }}"
          echo "åŒæ­¥è¯´æ˜Ž: ${{ github.event.inputs.sync_message }}"
          
          if [ "${{ github.event.inputs.source_branch }}" == "${{ github.event.inputs.target_branch }}" ]; then
            echo "âŒ é”™è¯¯: æºåˆ†æ”¯å’Œç›®æ ‡åˆ†æ”¯ä¸èƒ½ç›¸åŒ"
            exit 1
          fi

      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: èŽ·å–åˆ†æ”¯ä¿¡æ¯
        run: |
          echo "ðŸ“‹ èŽ·å–åˆ†æ”¯ä¿¡æ¯..."
          git fetch --all
          
          echo "å¯ç”¨çš„è¿œç¨‹åˆ†æ”¯:"
          git branch -r
          
          # æ£€æŸ¥æºåˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if ! git show-ref --verify --quiet refs/remotes/origin/${{ github.event.inputs.source_branch }}; then
            echo "âŒ é”™è¯¯: æºåˆ†æ”¯ '${{ github.event.inputs.source_branch }}' ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ£€æŸ¥ç›®æ ‡åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if ! git show-ref --verify --quiet refs/remotes/origin/${{ github.event.inputs.target_branch }}; then
            echo "âš ï¸ è­¦å‘Š: ç›®æ ‡åˆ†æ”¯ '${{ github.event.inputs.target_branch }}' ä¸å­˜åœ¨ï¼Œå°†ä¼šè¢«åˆ›å»º"
          fi

      - name: åˆ›å»ºç›®æ ‡åˆ†æ”¯ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
        run: |
          if ! git show-ref --verify --quiet refs/remotes/origin/${{ github.event.inputs.target_branch }}; then
            echo "ðŸ†• åˆ›å»ºç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
            git checkout -b ${{ github.event.inputs.target_branch }} origin/${{ github.event.inputs.source_branch }}
            git push -u origin ${{ github.event.inputs.target_branch }}
            echo "âœ… åˆ†æ”¯ '${{ github.event.inputs.target_branch }}' å·²åˆ›å»º"
          fi

      - name: æ‰§è¡ŒåŒæ­¥
        run: |
          echo "ðŸ”„ å¼€å§‹åŒæ­¥..."
          git checkout ${{ github.event.inputs.target_branch }}
          
          # æž„å»ºæäº¤æ¶ˆæ¯
          COMMIT_MSG="ðŸ”„ æ‰‹åŠ¨åŒæ­¥: ${{ github.event.inputs.source_branch }} â†’ ${{ github.event.inputs.target_branch }}

          ðŸ“ åŒæ­¥è¯¦æƒ…:
          - æºåˆ†æ”¯: ${{ github.event.inputs.source_branch }}
          - ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}
          - å¼ºåˆ¶åŒæ­¥: ${{ github.event.inputs.force_sync }}
          - æ“ä½œè€…: ${{ github.actor }}
          - è§¦å‘æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          if [ -n "${{ github.event.inputs.sync_message }}" ]; then
            COMMIT_MSG="$COMMIT_MSG
          - è¯´æ˜Ž: ${{ github.event.inputs.sync_message }}"
          fi
          
          COMMIT_MSG="$COMMIT_MSG

          ðŸ¤– æ­¤æäº¤ç”±æ‰‹åŠ¨åŒæ­¥å·¥ä½œæµç”Ÿæˆ"
          
          # æ ¹æ®å¼ºåˆ¶åŒæ­¥é€‰é¡¹æ‰§è¡Œä¸åŒçš„åˆå¹¶ç­–ç•¥
          if [ "${{ github.event.inputs.force_sync }}" == "true" ]; then
            echo "âš ï¸ å¼ºåˆ¶åŒæ­¥æ¨¡å¼: å°†å¼ºåˆ¶åˆå¹¶å¹¶è¦†ç›–å†²çª"
            git merge origin/${{ github.event.inputs.source_branch }} -X theirs --no-edit -m "$COMMIT_MSG"
          else
            echo "ðŸ¤ å¸¸è§„åŒæ­¥æ¨¡å¼: å°è¯•è‡ªåŠ¨åˆå¹¶"
            if git merge origin/${{ github.event.inputs.source_branch }} --no-edit -m "$COMMIT_MSG"; then
              echo "âœ… è‡ªåŠ¨åˆå¹¶æˆåŠŸ"
            else
              echo "âŒ æ£€æµ‹åˆ°åˆå¹¶å†²çª"
              echo "ðŸ’¡ æç¤º: å¦‚éœ€è¦†ç›–å†²çªï¼Œè¯·å¯ç”¨'å¼ºåˆ¶åŒæ­¥'é€‰é¡¹"
              
              # æ˜¾ç¤ºå†²çªæ–‡ä»¶
              echo ""
              echo "ðŸ” å†²çªæ–‡ä»¶åˆ—è¡¨:"
              git diff --name-only --diff-filter=U || echo "æ— æ³•èŽ·å–å†²çªæ–‡ä»¶åˆ—è¡¨"
              
              echo ""
              echo "ðŸ“– è§£å†³å†²çªçš„æ­¥éª¤:"
              echo "1. æœ¬åœ°æ£€å‡º ${{ github.event.inputs.target_branch }} åˆ†æ”¯"
              echo "2. è¿è¡Œ: git merge origin/${{ github.event.inputs.source_branch }}"
              echo "3. æ‰‹åŠ¨è§£å†³å†²çªæ–‡ä»¶"
              echo "4. è¿è¡Œ: git add . && git commit"
              echo "5. æŽ¨é€: git push origin ${{ github.event.inputs.target_branch }}"
              
              git merge --abort
              exit 1
            fi
          fi

      - name: æŽ¨é€æ›´æ”¹
        run: |
          echo "ðŸ“¤ æŽ¨é€æ›´æ”¹åˆ°ç›®æ ‡åˆ†æ”¯..."
          git push origin ${{ github.event.inputs.target_branch }}
          echo "âœ… åŒæ­¥å®Œæˆï¼"

      - name: ç”ŸæˆåŒæ­¥æŠ¥å‘Š
        if: success()
        run: |
          echo "## ðŸ“Š æ‰‹åŠ¨åŒæ­¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… åŒæ­¥æˆåŠŸå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| æºåˆ†æ”¯ | \`${{ github.event.inputs.source_branch }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ç›®æ ‡åˆ†æ”¯ | \`${{ github.event.inputs.target_branch }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| å¼ºåˆ¶åŒæ­¥ | ${{ github.event.inputs.force_sync }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ“ä½œè€… | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| åŒæ­¥æ—¶é—´ | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ github.event.inputs.sync_message }}" ]; then
            echo "| åŒæ­¥è¯´æ˜Ž | ${{ github.event.inputs.sync_message }} |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ åŒæ­¥ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # èŽ·å–æœ€è¿‘çš„å‡ ä¸ªæäº¤
          echo "**æœ€è¿‘åŒæ­¥çš„æäº¤:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          git log --oneline -5 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: é”™è¯¯å¤„ç†å’ŒæŠ¥å‘Š
        if: failure()
        run: |
          echo "## âŒ æ‰‹åŠ¨åŒæ­¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ åŒæ­¥å‚æ•°" >> $GITHUB_STEP_SUMMARY
          echo "- **æºåˆ†æ”¯**: \`${{ github.event.inputs.source_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ç›®æ ‡åˆ†æ”¯**: \`${{ github.event.inputs.target_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **å¼ºåˆ¶åŒæ­¥**: ${{ github.event.inputs.force_sync }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ“ä½œè€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ" >> $GITHUB_STEP_SUMMARY
          echo "1. æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
          echo "2. å¦‚æžœå­˜åœ¨åˆå¹¶å†²çªï¼Œå¯ç”¨'å¼ºåˆ¶åŒæ­¥'é€‰é¡¹" >> $GITHUB_STEP_SUMMARY
          echo "3. æ‰‹åŠ¨è§£å†³å†²çªåŽå†æ¬¡è¿è¡ŒåŒæ­¥" >> $GITHUB_STEP_SUMMARY
          echo "4. æ£€æŸ¥ä»“åº“æƒé™è®¾ç½®" >> $GITHUB_STEP_SUMMARY
