---
export interface Props {
	password: string;
	encryptedContent: string;
}

const { password, encryptedContent } = Astro.props;
---

<div class="password-protect-container">
	<div class="password-input-wrapper flex flex-col items-center justify-center min-h-[300px] p-8 rounded-xl bg-[var(--card-bg)] border border-[var(--line-divider)]">
		<div class="mb-6 text-center">
			<div class="text-2xl font-bold mb-2 text-[var(--primary)]">ğŸ”’</div>
			<h3 class="text-lg font-semibold mb-2">æ­¤æ–‡ç« å—å¯†ç ä¿æŠ¤</h3>
			<p class="text-sm text-[var(--meta-divider)] mb-4">è¯·è¾“å…¥å¯†ç ä»¥æŸ¥çœ‹å®Œæ•´å†…å®¹</p>
		</div>
		
		<div class="flex gap-3 w-full max-w-md">
			<input
				id="password-input"
				class="flex-1 rounded-lg border border-[var(--line-divider)] bg-[var(--card-bg)] p-3 text-[var(--primary)] placeholder:italic placeholder:text-[var(--meta-divider)] focus:border-[var(--primary)] focus:outline-none transition-colors"
				placeholder="è¯·è¾“å…¥å¯†ç ..."
				type="password"
				autocomplete="off"
				autofocus
			/>
			<button
				id="password-submit-btn"
				class="px-6 py-3 bg-[var(--primary)] text-white rounded-lg hover:bg-[var(--primary)]/80 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]/50 transition-all active:scale-95"
			>
				è§£é”
			</button>
		</div>
		
		<div id="password-error" class="mt-3 text-sm text-red-500 hidden">
			å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•
		</div>
	</div>
	
	<!-- éšè—çš„åŠ å¯†å†…å®¹ -->
	<meta name="encrypted-content" content={encryptedContent} />
</div>

<script is:inline data-astro-rerun>
	async function decrypt(data, key) {
		key = key.padEnd(16, "0");

		const decoder = new TextDecoder();
		const dataBuffer = new Uint8Array(
			atob(data)
				.split("")
				.map(c => c.charCodeAt(0))
		);
		const keyBuffer = new TextEncoder().encode(key);

		const cryptoKey = await crypto.subtle.importKey(
			"raw",
			keyBuffer,
			{ name: "AES-CBC", length: 256 },
			false,
			["decrypt"]
		);

		const iv = dataBuffer.slice(0, 16);
		const encryptedData = dataBuffer.slice(16);

		const decryptedData = await crypto.subtle.decrypt(
			{ name: "AES-CBC", iv },
			cryptoKey,
			encryptedData
		);

		return decoder.decode(decryptedData);
	}

	function setupPasswordUnlock() {
		const encryptedContent = document
			.querySelector("meta[name=encrypted-content]")
			?.getAttribute("content");
		
		if (!encryptedContent) return;

		const input = document.getElementById("password-input");
		const btn = document.getElementById("password-submit-btn");
		const errorDiv = document.getElementById("password-error");
		const container = document.querySelector(".password-protect-container");

		const handleSubmit = async () => {
			if (!input) return;
			
			const password = input.value.trim();
			if (!password) return;

			try {
				errorDiv?.classList.add("hidden");
				btn.textContent = "è§£é”ä¸­...";
				btn.disabled = true;

				const html = await decrypt(encryptedContent, password);
				
				// æ›¿æ¢æ•´ä¸ªå®¹å™¨å†…å®¹
				if (container) {
					container.innerHTML = html;
					
					// é‡æ–°æ‰§è¡Œå¯èƒ½å­˜åœ¨çš„è„šæœ¬
					const scripts = container.querySelectorAll("script");
					scripts.forEach(oldScript => {
						const newScript = document.createElement("script");
						Array.from(oldScript.attributes).forEach(attr => 
							newScript.setAttribute(attr.name, attr.value)
						);
						newScript.appendChild(document.createTextNode(oldScript.innerHTML));
						oldScript.parentNode?.replaceChild(newScript, oldScript);
					});
				}
			} catch (e) {
				console.error("è§£å¯†å¤±è´¥:", e);
				errorDiv?.classList.remove("hidden");
				btn.textContent = "è§£é”";
				btn.disabled = false;
			}
		};

		btn?.addEventListener("click", handleSubmit);
		input?.addEventListener("keypress", (e) => {
			if (e.key === "Enter") {
				handleSubmit();
			}
		});
	}

	// é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
	setupPasswordUnlock();
	
	// Astro é¡µé¢åˆ‡æ¢æ—¶é‡æ–°æ‰§è¡Œ
	document.addEventListener("astro:after-swap", setupPasswordUnlock);
</script>
